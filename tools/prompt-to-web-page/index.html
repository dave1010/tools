<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt to Web Page</title>
    <link rel="stylesheet" href="/assets/tw.css" />
  </head>
  <body class="bg-gradient-to-b from-brand-50/60 to-white">
    <main class="mx-auto max-w-3xl space-y-6 p-4 font-sans md:p-6">
      <header class="space-y-2 text-center">
        <h1 class="text-3xl font-semibold text-gray-900">Prompt to Web Page</h1>
        <p class="text-sm text-gray-600">
          Describe the page you want and generate a live preview using Cerebras gpt-oss-120b.
        </p>
      </header>

      <section class="rounded-2xl bg-white p-6 shadow">
        <form id="promptForm" class="space-y-4">
          <label class="space-y-2">
            <span class="block text-sm font-medium text-gray-700">Page prompt</span>
            <textarea
              id="promptInput"
              rows="6"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
              placeholder="Example: Create a launch page for a productivity app with feature cards and a pricing table."
            ></textarea>
          </label>
          <div class="flex flex-wrap items-center gap-3">
            <button
              id="submitButton"
              type="submit"
              class="bg-brand-600 text-white rounded-lg px-3 py-1.5 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
            >
              Generate web page
            </button>
            <p id="statusMessage" class="text-sm text-gray-500"></p>
          </div>
        </form>
      </section>

      <section class="space-y-4 rounded-2xl bg-white p-6 shadow">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold text-gray-900">Preview</h2>
          <button
            id="clearButton"
            type="button"
            class="text-sm font-medium text-brand-700 hover:text-brand-600"
          >
            Clear
          </button>
        </div>
        <p id="emptyState" class="text-sm text-gray-500">
          Submit a prompt to see the generated HTML page here.
        </p>
        <iframe
          id="previewFrame"
          title="Generated web page preview"
          class="hidden h-[480px] w-full rounded-xl border border-gray-200 bg-white"
        ></iframe>
        <details id="htmlDetails" class="hidden">
          <summary class="cursor-pointer text-sm font-medium text-brand-700 hover:text-brand-600">
            Show extracted HTML
          </summary>
          <textarea
            id="htmlOutput"
            readonly
            rows="12"
            class="mt-3 w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 font-mono text-xs text-gray-800"
          ></textarea>
        </details>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">← Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/prompt-to-web-page" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script>
      const SYSTEM_PROMPT =
        "You are an expert front-end engineer. Return just a single HTML page, surrounded by ```html and ``` with no other output.";

      const form = document.getElementById("promptForm");
      const promptInput = document.getElementById("promptInput");
      const submitButton = document.getElementById("submitButton");
      const statusMessage = document.getElementById("statusMessage");
      const previewFrame = document.getElementById("previewFrame");
      const emptyState = document.getElementById("emptyState");
      const htmlOutput = document.getElementById("htmlOutput");
      const htmlDetails = document.getElementById("htmlDetails");
      const clearButton = document.getElementById("clearButton");

      function setStatus(message, isError = false) {
        statusMessage.textContent = message || "";
        statusMessage.classList.toggle("text-red-600", Boolean(message) && isError);
        statusMessage.classList.toggle("text-gray-500", !isError);
      }

      function setLoading(isLoading) {
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading ? "Generating…" : "Generate web page";
        promptInput.disabled = isLoading;
      }

      function extractHtmlFromResponse(content) {
        if (typeof content !== "string" || !content.trim()) {
          return "";
        }
        const codeBlockMatch = content.match(/```html\s*([\s\S]*?)```/i);
        if (codeBlockMatch && codeBlockMatch[1]) {
          return codeBlockMatch[1].trim();
        }
        const fencedMatch = content.match(/```[\s\S]*?```/);
        if (fencedMatch) {
          return fencedMatch[0].replace(/```/g, "").trim();
        }
        return content.trim();
      }

      function showPreview(html) {
        if (!html) {
          previewFrame.classList.add("hidden");
          htmlDetails.classList.add("hidden");
          htmlOutput.value = "";
          emptyState.classList.remove("hidden");
          return;
        }
        previewFrame.srcdoc = html;
        previewFrame.classList.remove("hidden");
        htmlOutput.value = html;
        htmlDetails.classList.remove("hidden");
        emptyState.classList.add("hidden");
      }

      async function generatePage(prompt) {
        setLoading(true);
        setStatus("Calling Cerebras…");
        try {
          const response = await fetch("/cerebras-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "gpt-oss-120b",
              messages: [
                { role: "system", content: SYSTEM_PROMPT },
                { role: "user", content: prompt },
              ],
            }),
          });

          if (!response.ok) {
            let errorText = `Request failed (${response.status})`;
            try {
              const data = await response.json();
              errorText = data?.error || data?.message || errorText;
            } catch (error) {
              errorText = await response.text();
            }
            throw new Error(errorText);
          }

          const data = await response.json();
          const content = data?.choices?.[0]?.message?.content || "";
          const html = extractHtmlFromResponse(content);

          if (!html) {
            throw new Error("The model response did not include HTML content.");
          }

          showPreview(html);
          setStatus("Page generated successfully.");
        } catch (error) {
          console.error("Failed to generate page", error);
          setStatus(error?.message || "Unexpected error", true);
          showPreview("");
        } finally {
          setLoading(false);
        }
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const prompt = promptInput.value.trim();
        if (!prompt) {
          setStatus("Enter a prompt first.", true);
          return;
        }
        generatePage(prompt);
      });

      clearButton.addEventListener("click", () => {
        if (submitButton.disabled) {
          return;
        }
        promptInput.value = "";
        showPreview("");
        setStatus("");
        promptInput.focus();
      });

      showPreview("");
    </script>
  </body>
</html>
