<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt to Web Page</title>
    <link rel="stylesheet" href="/assets/tw.css" />
  </head>
  <body class="bg-gradient-to-b from-brand-50/60 to-white">
    <main class="mx-auto max-w-3xl space-y-6 p-4 font-sans md:p-6">
      <header class="space-y-2 text-center">
        <h1 class="text-3xl font-semibold text-gray-900">Prompt to Web Page</h1>
        <p class="text-sm text-gray-600">
          Describe the page you want and generate a live preview.
        </p>
      </header>

      <section class="rounded-2xl bg-white p-6 shadow">
        <form id="promptForm" class="space-y-4">
          <label class="space-y-2">
            <span class="block text-sm font-medium text-gray-700">Page prompt</span>
            <textarea
              id="promptInput"
              rows="6"
              required
              class="w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
              placeholder="Example: Create a launch page for a productivity app with feature cards and a pricing table."
            ></textarea>
          </label>
          <p class="text-xs text-gray-500">
            After the first draft, send follow-up instructions to iteratively refine the page.
          </p>
          <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-3">
              <button
                id="submitButton"
                type="submit"
                class="rounded-lg bg-brand-600 px-3 py-1.5 text-white hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
              >
                Generate web page
              </button>
              <div class="flex flex-wrap items-center gap-2">
                <button
                  id="openButton"
                  type="button"
                  class="rounded-lg border border-brand-200 bg-white px-3 py-1.5 text-sm font-medium text-brand-700 shadow-sm hover:bg-brand-50 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:border-gray-200 disabled:text-gray-400 disabled:shadow-none disabled:hover:bg-transparent"
                >
                  Open in new tab
                </button>
                <button
                  id="downloadButton"
                  type="button"
                  class="rounded-lg border border-brand-200 bg-white px-3 py-1.5 text-sm font-medium text-brand-700 shadow-sm hover:bg-brand-50 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:border-gray-200 disabled:text-gray-400 disabled:shadow-none disabled:hover:bg-transparent"
                >
                  Download HTML
                </button>
                <button
                  id="saveGistButton"
                  type="button"
                  class="rounded-lg border border-brand-200 bg-white px-3 py-1.5 text-sm font-medium text-brand-700 shadow-sm hover:bg-brand-50 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:border-gray-200 disabled:text-gray-400 disabled:shadow-none disabled:hover:bg-transparent"
                >
                  Save Gist
                </button>
                <button
                  id="viewHtmlButton"
                  type="button"
                  class="rounded-lg border border-brand-200 bg-white px-3 py-1.5 text-sm font-medium text-brand-700 shadow-sm hover:bg-brand-50 focus:outline-none focus:ring-2 focus:ring-brand-500/40 disabled:cursor-not-allowed disabled:border-gray-200 disabled:text-gray-400 disabled:shadow-none disabled:hover:bg-transparent"
                  aria-expanded="false"
                >
                  View HTML
                </button>
                <button
                  id="clearButton"
                  type="button"
                  class="rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
                >
                  Clear
                </button>
              </div>
            </div>
            <p id="statusMessage" class="text-sm text-gray-500"></p>
          </div>
        </form>
      </section>

      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold text-gray-900">Preview</h2>
        </div>
        <p id="emptyState" class="text-sm text-gray-500">
          Submit a prompt to see the generated HTML page here.
        </p>
        <div
          id="previewContainer"
          class="hidden overflow-hidden rounded-2xl bg-white shadow"
        >
          <iframe
            id="previewFrame"
            title="Generated web page preview"
            class="h-[520px] w-full border-0"
          ></iframe>
        </div>
      </div>

      <section
        id="htmlContainer"
        class="hidden space-y-3 rounded-2xl bg-white p-6 shadow"
        aria-label="Extracted HTML"
      >
        <h2 class="text-base font-semibold text-gray-900">Extracted HTML</h2>
        <textarea
          id="htmlOutput"
          readonly
          rows="12"
          class="w-full rounded-lg border border-gray-300 bg-gray-50 px-3 py-2 font-mono text-xs text-gray-800"
        ></textarea>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">← Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/prompt-to-web-page" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script>
      const SYSTEM_PROMPT =
        "You are an expert front-end engineer. Return just a single HTML page, surrounded by ```html and ``` with no other output.";

      const form = document.getElementById("promptForm");
      const promptInput = document.getElementById("promptInput");
      const submitButton = document.getElementById("submitButton");
      const statusMessage = document.getElementById("statusMessage");
      const previewFrame = document.getElementById("previewFrame");
      const previewContainer = document.getElementById("previewContainer");
      const emptyState = document.getElementById("emptyState");
      const htmlOutput = document.getElementById("htmlOutput");
      const htmlContainer = document.getElementById("htmlContainer");
      const clearButton = document.getElementById("clearButton");
      const openButton = document.getElementById("openButton");
      const downloadButton = document.getElementById("downloadButton");
      const saveGistButton = document.getElementById("saveGistButton");
      const viewHtmlButton = document.getElementById("viewHtmlButton");

      const conversationHistory = [];
      let currentHtml = "";
      let lastPrompt = "";
      const defaultPlaceholder = promptInput.placeholder;
      let isHtmlVisible = false;

      function updateActionButtonsState(hasHtml) {
        openButton.disabled = !hasHtml;
        downloadButton.disabled = !hasHtml;
        saveGistButton.disabled = !hasHtml;
        viewHtmlButton.disabled = !hasHtml;
        if (!hasHtml) {
          isHtmlVisible = false;
          htmlContainer.classList.add("hidden");
          viewHtmlButton.textContent = "View HTML";
          viewHtmlButton.setAttribute("aria-expanded", "false");
        }
      }

      function setStatus(message, isError = false, asHtml = false) {
        statusMessage.textContent = "";
        if (message) {
          if (asHtml) {
            statusMessage.innerHTML = message;
          } else {
            statusMessage.textContent = message;
          }
        }
        statusMessage.classList.toggle("text-red-600", Boolean(message) && isError);
        statusMessage.classList.toggle("text-gray-500", !isError);
      }

      function setLoading(isLoading) {
        submitButton.disabled = isLoading;
        submitButton.textContent = isLoading ? "Generating…" : "Generate web page";
        promptInput.disabled = isLoading;
      }

      function extractHtmlFromResponse(content) {
        if (typeof content !== "string" || !content.trim()) {
          return "";
        }
        const codeBlockMatch = content.match(/```html\s*([\s\S]*?)```/i);
        if (codeBlockMatch && codeBlockMatch[1]) {
          return codeBlockMatch[1].trim();
        }
        const fencedMatch = content.match(/```[\s\S]*?```/);
        if (fencedMatch) {
          return fencedMatch[0].replace(/```/g, "").trim();
        }
        return content.trim();
      }

      function showPreview(html) {
        currentHtml = html || "";

        if (!html) {
          previewContainer.classList.add("hidden");
          previewFrame.classList.add("hidden");
          htmlContainer.classList.add("hidden");
          viewHtmlButton.setAttribute("aria-expanded", "false");
          viewHtmlButton.textContent = "View HTML";
          htmlOutput.value = "";
          emptyState.classList.remove("hidden");
          updateActionButtonsState(false);
          lastPrompt = "";
          return;
        }
        previewFrame.srcdoc = html;
        previewContainer.classList.remove("hidden");
        previewFrame.classList.remove("hidden");
        htmlOutput.value = html;
        emptyState.classList.add("hidden");
        updateActionButtonsState(true);
      }

      async function generatePage(prompt) {
        setLoading(true);
        setStatus("Calling Cerebras…");
        try {
          const messages = [
            { role: "system", content: SYSTEM_PROMPT },
            ...conversationHistory,
            { role: "user", content: prompt },
          ];
          const response = await fetch("/cerebras-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "gpt-oss-120b",
              messages,
            }),
          });

          if (!response.ok) {
            let errorText = `Request failed (${response.status})`;
            try {
              const data = await response.json();
              errorText = data?.error || data?.message || errorText;
            } catch (error) {
              errorText = await response.text();
            }
            throw new Error(errorText);
          }

          const data = await response.json();
          const content = data?.choices?.[0]?.message?.content || "";
          const html = extractHtmlFromResponse(content);

          if (!html) {
            throw new Error("The model response did not include HTML content.");
          }

          showPreview(html);
          setStatus("Page generated successfully.");
          conversationHistory.push({ role: "user", content: prompt });
          conversationHistory.push({ role: "assistant", content });
          promptInput.placeholder = "Add follow-up instructions or start a new page.";
          lastPrompt = prompt;
        } catch (error) {
          console.error("Failed to generate page", error);
          setStatus(error?.message || "Unexpected error", true);
          showPreview("");
        } finally {
          setLoading(false);
        }
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const prompt = promptInput.value.trim();
        if (!prompt) {
          setStatus("Enter a prompt first.", true);
          return;
        }
        generatePage(prompt);
      });

      clearButton.addEventListener("click", () => {
        if (submitButton.disabled) {
          return;
        }
        promptInput.value = "";
        showPreview("");
        setStatus("");
        promptInput.focus();
        conversationHistory.length = 0;
        updateActionButtonsState(false);
        promptInput.placeholder = defaultPlaceholder;
      });

      viewHtmlButton.addEventListener("click", () => {
        if (!currentHtml || viewHtmlButton.disabled) {
          return;
        }
        isHtmlVisible = !isHtmlVisible;
        htmlContainer.classList.toggle("hidden", !isHtmlVisible);
        viewHtmlButton.textContent = isHtmlVisible ? "Hide HTML" : "View HTML";
        viewHtmlButton.setAttribute("aria-expanded", String(isHtmlVisible));
      });

      openButton.addEventListener("click", () => {
        if (!currentHtml) {
          return;
        }
        const newWindow = window.open();
        if (newWindow) {
          newWindow.document.write(currentHtml);
          newWindow.document.close();
        } else {
          alert("Pop-up blocked. Allow pop-ups for this site to open the preview in a new tab.");
        }
      });

      downloadButton.addEventListener("click", () => {
        if (!currentHtml) {
          return;
        }
        const blob = new Blob([currentHtml], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "generated-page.html";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      });

      function buildLoginLink() {
        return '<a href="/tools/github-device-login/" target="_blank" rel="noopener noreferrer" class="underline">Log in with GitHub</a>';
      }

      async function saveGist() {
        if (!currentHtml || saveGistButton.disabled) {
          return;
        }

        if (!lastPrompt) {
          setStatus("Prompt not found. Generate a page before saving a gist.", true);
          return;
        }

        const tokenKey = "github-device-login-token";
        const token = localStorage.getItem(tokenKey);

        if (!token) {
          setStatus(`GitHub token not found. ${buildLoginLink()} to save a gist.`, true, true);
          return;
        }

        saveGistButton.disabled = true;
        const originalText = saveGistButton.textContent;
        saveGistButton.textContent = "Saving…";
        setStatus("Saving gist…");

        try {
          const response = await fetch("https://api.github.com/gists", {
            method: "POST",
            headers: {
              Accept: "application/vnd.github+json",
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              description: "Generated with Prompt to Web Page",
              public: false,
              files: {
                "index.html": {
                  content: currentHtml,
                },
                "README.md": {
                  content: `# Prompt\n\n${lastPrompt}\n`,
                },
              },
            }),
          });

          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              localStorage.removeItem(tokenKey);
              throw new Error(`GitHub token was rejected. ${buildLoginLink()} to refresh it.`);
            }

            let errorDetail = `${response.status} ${response.statusText}`;
            try {
              const data = await response.json();
              if (data?.message) {
                errorDetail = data.message;
              }
            } catch (error) {
              // Ignore JSON parsing errors and fall back to status text
            }
            throw new Error(`Failed to save gist: ${errorDetail}`);
          }

          const gist = await response.json();
          const gistId = gist?.id;
          const gistUrl = gist?.html_url;

          if (!gistId || !gistUrl) {
            throw new Error("Saved gist but response was missing details.");
          }

          const gistPreviewUrl = `https://gistpreview.github.io/?${encodeURIComponent(gistId)}`;
          setStatus(
            `Saved gist: <a href="${gistUrl}" target="_blank" rel="noopener noreferrer" class="underline">View on GitHub</a> · <a href="${gistPreviewUrl}" target="_blank" rel="noopener noreferrer" class="underline">Preview gist</a>`,
            false,
            true
          );
        } catch (error) {
          const message = error?.message || "Failed to save gist.";
          const needsLoginLink = message.toLowerCase().includes("token");
          setStatus(needsLoginLink ? message : `${message} ${buildLoginLink()}`, true, true);
        } finally {
          saveGistButton.textContent = originalText;
          updateActionButtonsState(Boolean(currentHtml));
        }
      }

      saveGistButton.addEventListener("click", saveGist);

      showPreview("");
      updateActionButtonsState(false);
    </script>
  </body>
</html>
