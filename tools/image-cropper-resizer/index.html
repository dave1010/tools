<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Cropper &amp; Resizer</title>
    <link rel="stylesheet" href="/assets/tw.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css"
      onerror="alert('Failed to load: ' + this.href)"
    />
    <style>
      .cropper-view-box,
      .cropper-face {
        border-radius: 1rem;
      }
    </style>
  </head>
  <body class="bg-gradient-to-b from-brand-50/60 to-white">
    <main class="mx-auto max-w-5xl p-4 md:p-6 space-y-6 font-sans">
      <header class="space-y-2 text-center">
        <h1 class="text-3xl font-semibold text-gray-900">Image Cropper &amp; Resizer</h1>
        <p class="text-gray-600">Upload, crop, rotate, and export polished images in the size you need.</p>
      </header>

      <section class="card space-y-6 rounded-2xl border border-gray-200 bg-white p-4 shadow-soft md:p-6">
        <div class="grid gap-6 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1fr)]">
          <div class="space-y-6">
            <div class="space-y-3">
              <label for="file-input" class="block text-sm font-medium text-gray-700">Upload an image</label>
              <input
                id="file-input"
                type="file"
                accept="image/*"
                class="block w-full cursor-pointer rounded-xl border border-dashed border-brand-200 bg-brand-50/40 px-4 py-3 text-sm text-gray-700 focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
              />
              <p class="text-xs text-gray-500">Large files are supported; everything stays in your browser.</p>
            </div>

            <div class="space-y-4">
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-2">
                  <span class="text-sm font-medium text-gray-700">Aspect ratio</span>
                  <select
                    id="aspect-ratio"
                    class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-soft focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                    disabled
                  >
                    <option value="free">Free</option>
                    <option value="1">1:1 (Square)</option>
                    <option value="16/9">16:9 (Widescreen)</option>
                    <option value="4/3">4:3 (Classic)</option>
                    <option value="3/2">3:2 (Photo)</option>
                    <option value="custom">Custom…</option>
                  </select>
                </label>
                <label class="space-y-2">
                  <span class="text-sm font-medium text-gray-700">Dimension presets</span>
                  <select
                    id="dimension-preset"
                    class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-soft focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                    disabled
                  >
                    <option value="original">Use crop size</option>
                    <option value="1080p">1080p (1920 × 1080)</option>
                    <option value="square-1024">Square (1024 × 1024)</option>
                    <option value="social-1080">Instagram (1080 × 1350)</option>
                    <option value="thumb-512">Thumbnail (512 × 512)</option>
                    <option value="custom">Custom size…</option>
                  </select>
                </label>
              </div>

              <div id="custom-aspect" class="hidden grid gap-3 rounded-xl bg-brand-50/60 p-3 md:grid-cols-2">
                <div class="grid gap-2 md:grid-cols-2">
                  <label class="space-y-1">
                    <span class="text-xs font-medium text-gray-600">Width</span>
                    <input
                      type="number"
                      min="1"
                      id="custom-aspect-width"
                      class="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                    />
                  </label>
                  <label class="space-y-1">
                    <span class="text-xs font-medium text-gray-600">Height</span>
                    <input
                      type="number"
                      min="1"
                      id="custom-aspect-height"
                      class="w-full rounded-lg border border-gray-300 px-3 py-1.5 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                    />
                  </label>
                </div>
                <button
                  id="apply-custom-aspect"
                  type="button"
                  class="btn btn-secondary w-full justify-center"
                >
                  Apply custom aspect
                </button>
              </div>

              <div class="rounded-2xl border border-gray-200 bg-gray-50 p-4">
                <h2 class="text-sm font-semibold text-gray-700">Export dimensions</h2>
                <div class="mt-3 grid gap-3 md:grid-cols-2">
                  <label class="space-y-1">
                    <span class="text-xs font-medium text-gray-600">Width (px)</span>
                    <input
                      type="number"
                      id="output-width"
                      min="1"
                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                      disabled
                    />
                  </label>
                  <label class="space-y-1">
                    <span class="text-xs font-medium text-gray-600">Height (px)</span>
                    <input
                      type="number"
                      id="output-height"
                      min="1"
                      class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                      disabled
                    />
                  </label>
                  <label class="flex items-center gap-2 md:col-span-2">
                    <input type="checkbox" id="lock-dimensions" class="h-4 w-4 rounded border-gray-300 text-brand-600 focus:ring-brand-500" checked disabled />
                    <span class="text-xs text-gray-600">Keep aspect ratio when adjusting width or height</span>
                  </label>
                </div>
                <p class="mt-3 text-xs text-gray-500">Preset sizes update these fields automatically. You can also set any custom dimensions.</p>
              </div>

              <div class="grid gap-4 md:grid-cols-2">
                <label class="space-y-2">
                  <span class="text-sm font-medium text-gray-700">Zoom</span>
                  <input
                    id="zoom-range"
                    type="range"
                    min="0.2"
                    max="3"
                    step="0.01"
                    value="1"
                    class="w-full accent-brand-600"
                    disabled
                  />
                </label>
                <label class="space-y-2">
                  <span class="text-sm font-medium text-gray-700">Rotation</span>
                  <input
                    id="rotate-range"
                    type="range"
                    min="-180"
                    max="180"
                    step="1"
                    value="0"
                    class="w-full accent-brand-600"
                    disabled
                  />
                </label>
              </div>

              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-2">
                  <span class="text-sm font-medium text-gray-700">Resampling quality</span>
                  <select
                    id="smoothing"
                    class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm shadow-soft focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500"
                    disabled
                  >
                    <option value="high">High (smooth)</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low (faster)</option>
                  </select>
                </label>
                <button
                  id="reset-view"
                  type="button"
                  class="btn btn-secondary mt-auto w-full justify-center"
                  disabled
                >
                  Reset view
                </button>
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <div class="relative flex aspect-video items-center justify-center overflow-hidden rounded-2xl border border-dashed border-gray-300 bg-gray-100 p-2">
              <img id="preview" alt="Uploaded preview" class="max-h-full opacity-0" />
              <p id="placeholder" class="pointer-events-none absolute text-center text-sm text-gray-500">
                Drop an image here or use the uploader to get started.
              </p>
            </div>

            <dl class="grid gap-3 rounded-2xl border border-gray-200 bg-gray-50 p-4 text-sm text-gray-700 md:grid-cols-2">
              <div>
                <dt class="font-semibold">Crop area</dt>
                <dd id="crop-info">—</dd>
              </div>
              <div>
                <dt class="font-semibold">Aspect ratio</dt>
                <dd id="aspect-info">—</dd>
              </div>
              <div>
                <dt class="font-semibold">Export size</dt>
                <dd id="export-info">—</dd>
              </div>
              <div>
                <dt class="font-semibold">Zoom level</dt>
                <dd id="zoom-info">—</dd>
              </div>
            </dl>

            <div class="flex flex-wrap items-center gap-3">
              <button id="download" type="button" class="btn btn-primary flex-1 justify-center" disabled>Download cropped image</button>
              <span id="status" class="text-sm text-gray-500"></span>
            </div>
          </div>
        </div>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">&larr; Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/image-cropper-resizer" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js" onerror="alert('Failed to load: ' + this.src)"></script>
    <script>
      const fileInput = document.getElementById("file-input");
      const previewImage = document.getElementById("preview");
      const placeholder = document.getElementById("placeholder");
      const aspectRatioSelect = document.getElementById("aspect-ratio");
      const dimensionPresetSelect = document.getElementById("dimension-preset");
      const customAspectPanel = document.getElementById("custom-aspect");
      const customAspectWidth = document.getElementById("custom-aspect-width");
      const customAspectHeight = document.getElementById("custom-aspect-height");
      const applyCustomAspectButton = document.getElementById("apply-custom-aspect");
      const outputWidthInput = document.getElementById("output-width");
      const outputHeightInput = document.getElementById("output-height");
      const lockDimensionsCheckbox = document.getElementById("lock-dimensions");
      const zoomRange = document.getElementById("zoom-range");
      const rotateRange = document.getElementById("rotate-range");
      const smoothingSelect = document.getElementById("smoothing");
      const resetViewButton = document.getElementById("reset-view");
      const downloadButton = document.getElementById("download");
      const statusMessage = document.getElementById("status");
      const cropInfo = document.getElementById("crop-info");
      const aspectInfo = document.getElementById("aspect-info");
      const exportInfo = document.getElementById("export-info");
      const zoomInfo = document.getElementById("zoom-info");

      let cropper = null;
      let dimensionDirty = false;
      let lastCropData = null;

      const enableControls = (enabled) => {
        [
          aspectRatioSelect,
          dimensionPresetSelect,
          outputWidthInput,
          outputHeightInput,
          lockDimensionsCheckbox,
          zoomRange,
          rotateRange,
          smoothingSelect,
          resetViewButton,
          downloadButton,
        ].forEach((el) => {
          el.disabled = !enabled;
        });

        if (!enabled) {
          statusMessage.textContent = "";
        }
      };

      const round = (value) => Math.round(value * 100) / 100;

      const formatAspect = (ratio, { includeDecimal = true } = {}) => {
        if (!Number.isFinite(ratio) || ratio <= 0) {
          return "—";
        }
        const gcd = (a, b) => (b ? gcd(b, a % b) : a);
        const numerator = Math.round(ratio * 1000);
        const denominator = 1000;
        const divisor = gcd(numerator, denominator);
        const simplifiedNumerator = Math.round(numerator / divisor);
        const simplifiedDenominator = Math.round(denominator / divisor);
        const label = `${simplifiedNumerator}:${simplifiedDenominator}`;
        return includeDecimal ? `${label} (${ratio.toFixed(3)}:1)` : label;
      };

      const updateZoomInfo = () => {
        if (!cropper) {
          zoomInfo.textContent = "—";
          return;
        }
        const imageData = cropper.getImageData();
        if (imageData && imageData.naturalWidth) {
          const zoomValue = imageData.width / imageData.naturalWidth;
          const min = Number.parseFloat(zoomRange.min);
          const max = Number.parseFloat(zoomRange.max);
          const clamped = Math.min(Math.max(zoomValue, min), max);
          zoomRange.value = round(clamped);
          zoomInfo.textContent = `${(zoomValue * 100).toFixed(0)}%`;
        }
      };

      const updateExportInfo = () => {
        const width = Number.parseInt(outputWidthInput.value, 10);
        const height = Number.parseInt(outputHeightInput.value, 10);
        if (width > 0 && height > 0) {
          const ratioText = formatAspect(width / height);
          exportInfo.textContent = `${width} × ${height}px${ratioText !== "—" ? ` • ${ratioText}` : ""}`;
        } else {
          exportInfo.textContent = "—";
        }
      };

      const updateCropDetails = (detail) => {
        if (!detail) {
          cropInfo.textContent = "—";
          aspectInfo.textContent = "—";
          return;
        }
        const width = Math.max(1, Math.round(detail.width));
        const height = Math.max(1, Math.round(detail.height));
        cropInfo.textContent = `${width} × ${height}px`;
        const ratio = width / height;
        aspectInfo.textContent = formatAspect(ratio);
        lastCropData = { width, height, ratio };

        if (!dimensionDirty) {
          outputWidthInput.value = width;
          outputHeightInput.value = height;
          updateExportInfo();
        }
      };

      const resetDimensionDirty = () => {
        dimensionDirty = false;
        dimensionPresetSelect.value = "original";
        if (lastCropData) {
          outputWidthInput.value = lastCropData.width;
          outputHeightInput.value = lastCropData.height;
          updateExportInfo();
        }
      };

      const handleFile = (file) => {
        if (!file || !file.type.startsWith("image/")) {
          statusMessage.textContent = "Please choose an image file.";
          return;
        }

        const url = URL.createObjectURL(file);
        previewImage.onload = () => {
          URL.revokeObjectURL(url);
          placeholder.classList.add("hidden");
          previewImage.classList.remove("opacity-0");
          if (cropper) {
            cropper.replace(previewImage.src, false);
          } else {
            cropper = new Cropper(previewImage, {
              viewMode: 1,
              autoCropArea: 1,
              responsive: true,
              background: false,
              checkOrientation: false,
              ready() {
                enableControls(true);
                resetDimensionDirty();
                updateZoomInfo();
              },
              crop(event) {
                updateCropDetails(event.detail);
                if (!dimensionDirty) {
                  updateExportInfo();
                }
                updateZoomInfo();
              },
              zoom() {
                updateZoomInfo();
              },
            });
          }
          enableControls(true);
          resetDimensionDirty();
          updateZoomInfo();
          statusMessage.textContent = "";
        };
        previewImage.src = url;
      };

      fileInput.addEventListener("change", (event) => {
        const [file] = event.target.files || [];
        handleFile(file);
      });

      const preventDefaults = (event) => {
        event.preventDefault();
        event.stopPropagation();
      };

      [document.body].forEach((target) => {
        target.addEventListener("dragover", preventDefaults);
        target.addEventListener("drop", preventDefaults);
      });

      const dropZone = previewImage.parentElement;
      dropZone.addEventListener("dragover", () => {
        dropZone.classList.add("ring-2", "ring-brand-500");
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("ring-2", "ring-brand-500");
      });
      dropZone.addEventListener("drop", (event) => {
        preventDefaults(event);
        dropZone.classList.remove("ring-2", "ring-brand-500");
        const file = event.dataTransfer?.files?.[0];
        if (file) {
          handleFile(file);
        }
      });

      aspectRatioSelect.addEventListener("change", () => {
        if (!cropper) {
          return;
        }
        const value = aspectRatioSelect.value;
        if (value === "custom") {
          customAspectPanel.classList.remove("hidden");
          if (lastCropData) {
            customAspectWidth.value = lastCropData.width;
            customAspectHeight.value = lastCropData.height;
          }
          customAspectWidth.focus();
          return;
        }
        customAspectPanel.classList.add("hidden");
        if (value === "free") {
          cropper.setAspectRatio(NaN);
          return;
        }
        let ratio = Number.NaN;
        if (value.includes("/")) {
          const [w, h] = value.split("/").map((part) => Number.parseFloat(part));
          if (w > 0 && h > 0) {
            ratio = w / h;
          }
        } else {
          const numeric = Number.parseFloat(value);
          if (numeric > 0) {
            ratio = numeric;
          }
        }
        if (Number.isFinite(ratio) && ratio > 0) {
          cropper.setAspectRatio(ratio);
        }
      });

      applyCustomAspectButton.addEventListener("click", () => {
        if (!cropper) {
          return;
        }
        const width = Number.parseFloat(customAspectWidth.value);
        const height = Number.parseFloat(customAspectHeight.value);
        if (width > 0 && height > 0) {
          const ratio = width / height;
          cropper.setAspectRatio(ratio);
          customAspectPanel.classList.add("hidden");
          aspectRatioSelect.value = "custom";
          statusMessage.textContent = "";
        } else {
          statusMessage.textContent = "Enter valid numbers for custom aspect ratio.";
        }
      });

      const applyDimensionPreset = (value) => {
        if (!lastCropData) {
          return;
        }
        switch (value) {
          case "1080p":
            outputWidthInput.value = 1920;
            outputHeightInput.value = 1080;
            break;
          case "square-1024":
            outputWidthInput.value = 1024;
            outputHeightInput.value = 1024;
            break;
          case "social-1080":
            outputWidthInput.value = 1080;
            outputHeightInput.value = 1350;
            break;
          case "thumb-512":
            outputWidthInput.value = 512;
            outputHeightInput.value = 512;
            break;
          case "original":
            resetDimensionDirty();
            return;
          default:
            return;
        }
        dimensionDirty = true;
        updateExportInfo();
      };

      dimensionPresetSelect.addEventListener("change", () => {
        if (!cropper) {
          return;
        }
        const value = dimensionPresetSelect.value;
        if (value === "custom") {
          dimensionDirty = true;
          return;
        }
        applyDimensionPreset(value);
      });

      const maintainAspect = () => lockDimensionsCheckbox.checked && lastCropData?.ratio;

      outputWidthInput.addEventListener("input", () => {
        if (!cropper) {
          return;
        }
        dimensionDirty = true;
        dimensionPresetSelect.value = "custom";
        const width = Number.parseFloat(outputWidthInput.value);
        const ratio = maintainAspect();
        if (ratio && width > 0) {
          outputHeightInput.value = Math.round(width / ratio);
        }
        updateExportInfo();
      });

      outputHeightInput.addEventListener("input", () => {
        if (!cropper) {
          return;
        }
        dimensionDirty = true;
        dimensionPresetSelect.value = "custom";
        const height = Number.parseFloat(outputHeightInput.value);
        const ratio = maintainAspect();
        if (ratio && height > 0) {
          outputWidthInput.value = Math.round(height * ratio);
        }
        updateExportInfo();
      });

      lockDimensionsCheckbox.addEventListener("change", () => {
        dimensionDirty = true;
        dimensionPresetSelect.value = "custom";
      });

      zoomRange.addEventListener("input", () => {
        if (!cropper) {
          return;
        }
        const zoomValue = Number.parseFloat(zoomRange.value);
        cropper.zoomTo(zoomValue);
        updateZoomInfo();
      });

      rotateRange.addEventListener("input", () => {
        if (!cropper) {
          return;
        }
        cropper.rotateTo(Number.parseFloat(rotateRange.value));
      });

      resetViewButton.addEventListener("click", () => {
        if (!cropper) {
          return;
        }
        cropper.reset();
        rotateRange.value = "0";
        zoomRange.value = "1";
        updateZoomInfo();
        resetDimensionDirty();
        statusMessage.textContent = "View reset.";
      });

      const triggerDownload = (blob) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `cropped-${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      };

      downloadButton.addEventListener("click", () => {
        if (!cropper) {
          return;
        }
        const width = Number.parseInt(outputWidthInput.value, 10);
        const height = Number.parseInt(outputHeightInput.value, 10);
        if (!(width > 0 && height > 0)) {
          statusMessage.textContent = "Set valid export dimensions first.";
          return;
        }
        const canvas = cropper.getCroppedCanvas({
          width,
          height,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: smoothingSelect.value,
        });
        if (!canvas) {
          statusMessage.textContent = "Unable to create a cropped canvas.";
          return;
        }
        canvas.toBlob(
          (blob) => {
            if (blob) {
              triggerDownload(blob);
              statusMessage.textContent = "Download ready.";
            } else {
              statusMessage.textContent = "Unable to export image.";
            }
          },
          "image/png",
          1
        );
      });

    </script>
  </body>
</html>
