<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Reader</title>
    <link rel="stylesheet" href="/assets/tw.css" />
  </head>
  <body class="bg-gradient-to-b from-brand-50/60 to-white">
    <main class="mx-auto flex min-h-screen max-w-3xl flex-col items-center justify-center space-y-6 p-4 font-sans md:p-6">
      <div class="w-full max-w-2xl space-y-6 rounded-2xl border border-gray-200 bg-white p-6 shadow-soft md:p-8">
        <header class="text-center">
          <h1 class="text-3xl font-semibold text-gray-900">QR Code Reader</h1>
        </header>

        <section>
          <div
            id="drop-zone"
            class="group relative flex cursor-pointer flex-col items-center justify-center space-y-3 rounded-2xl border-2 border-dashed border-gray-300 bg-gray-50/80 p-8 text-center transition hover:border-brand-500 hover:bg-brand-50"
          >
            <svg class="h-12 w-12 text-brand-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M7.5 12l4.5 4.5m0 0 4.5-4.5m-4.5 4.5V3" />
            </svg>
            <div class="space-y-1">
              <p class="text-base font-medium text-gray-900">
                Drop an image with a QR code or <span class="text-brand-600 underline">browse your files</span>
              </p>
              <p class="text-sm text-gray-500">PNG, JPG, or WebP images work best.</p>
            </div>
            <input
              id="file-input"
              type="file"
              accept="image/png,image/jpeg,image/webp,image/gif"
              class="absolute inset-0 h-full w-full cursor-pointer opacity-0"
            />
          </div>
        </section>

        <section class="space-y-3">
          <div class="space-y-1">
            <h2 class="text-xl font-semibold text-gray-900">Result</h2>
            <p id="status-text" class="text-sm text-gray-500">No QR code decoded yet.</p>
          </div>
          <div class="space-y-3">
            <div class="overflow-hidden rounded-xl border border-gray-200">
              <textarea
                id="result-field"
                class="h-36 w-full resize-y border-0 bg-white p-3 text-base text-gray-900 focus:ring-0"
                placeholder="Decoded QR code text will appear here."
                readonly
              ></textarea>
            </div>
            <div class="flex flex-wrap items-center gap-3">
              <button
                id="copy-button"
                type="button"
                class="bg-brand-600 text-white rounded-lg px-3 py-1.5 hover:bg-brand-700 disabled:cursor-not-allowed disabled:opacity-60"
                disabled
              >
                Copy text
              </button>
              <p id="copy-feedback" class="text-sm text-gray-500"></p>
            </div>
          </div>
        </section>

        <section class="space-y-3">
          <h2 class="text-xl font-semibold text-gray-900">Preview</h2>
          <div class="flex min-h-[200px] items-center justify-center overflow-hidden rounded-xl border border-dashed border-gray-200 bg-gray-50 p-4">
            <img id="preview-image" alt="Uploaded QR code preview" class="max-h-64 w-auto rounded-lg shadow-sm hidden" />
            <p id="preview-placeholder" class="text-sm text-gray-500">Your uploaded image preview will appear here.</p>
          </div>
        </section>
      </div>
      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex flex-wrap justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">&larr; Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/qr-code-reader" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
      const dropZone = document.getElementById("drop-zone");
      const fileInput = document.getElementById("file-input");
      const statusText = document.getElementById("status-text");
      const resultField = document.getElementById("result-field");
      const copyButton = document.getElementById("copy-button");
      const copyFeedback = document.getElementById("copy-feedback");
      const previewImage = document.getElementById("preview-image");
      const previewPlaceholder = document.getElementById("preview-placeholder");

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");

      const resetResult = () => {
        resultField.value = "";
        copyButton.disabled = true;
        copyFeedback.textContent = "";
      };

      const setStatus = (message, tone = "info") => {
        statusText.textContent = message;
        statusText.className = "text-sm " + (tone === "error" ? "text-red-600" : tone === "success" ? "text-green-600" : "text-gray-500");
      };

      const updatePreview = (url) => {
        if (url) {
          previewImage.src = url;
          previewImage.classList.remove("hidden");
          previewPlaceholder.classList.add("hidden");
        } else {
          previewImage.removeAttribute("src");
          previewImage.classList.add("hidden");
          previewPlaceholder.classList.remove("hidden");
        }
      };

      const decodeImage = (file) => {
        if (!file || !file.type.startsWith("image/")) {
          setStatus("Please choose an image file containing a QR code.", "error");
          resetResult();
          updatePreview(null);
          return;
        }

        const url = URL.createObjectURL(file);
        const image = new Image();
        image.onload = () => {
          canvas.width = image.naturalWidth || image.width;
          canvas.height = image.naturalHeight || image.height;
          context.drawImage(image, 0, 0, canvas.width, canvas.height);
          URL.revokeObjectURL(url);

          try {
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "attemptBoth",
            });

            if (code && code.data) {
              resultField.value = code.data;
              copyButton.disabled = false;
              setStatus("QR code decoded successfully.", "success");
            } else {
              resetResult();
              setStatus("No QR code found. Try a clearer image or adjust lighting.", "error");
            }
          } catch (error) {
            resetResult();
            setStatus("Something went wrong while decoding the image.", "error");
            console.error(error);
          }
        };

        image.onerror = () => {
          URL.revokeObjectURL(url);
          resetResult();
          updatePreview(null);
          setStatus("Unable to load the selected image.", "error");
        };

        updatePreview(url);
        setStatus("Processing imageâ€¦", "info");
        image.src = url;
      };

      fileInput.addEventListener("change", (event) => {
        const [file] = event.target.files;
        decodeImage(file);
      });

      dropZone.addEventListener("dragover", (event) => {
        event.preventDefault();
        dropZone.classList.add("border-brand-500", "bg-brand-50");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("border-brand-500", "bg-brand-50");
      });

      dropZone.addEventListener("drop", (event) => {
        event.preventDefault();
        dropZone.classList.remove("border-brand-500", "bg-brand-50");
        const [file] = event.dataTransfer.files;
        if (file) {
          fileInput.files = event.dataTransfer.files;
          decodeImage(file);
        }
      });

      copyButton.addEventListener("click", async () => {
        const text = resultField.value;
        if (!text) {
          return;
        }

        try {
          await navigator.clipboard.writeText(text);
          copyFeedback.textContent = "Copied to clipboard.";
          setStatus("Text copied to clipboard.", "success");
        } catch (error) {
          copyFeedback.textContent = "Copy failed. Select the text manually.";
          setStatus("Copy failed. You may need to grant clipboard permissions.", "error");
          console.error(error);
        }

        setTimeout(() => {
          copyFeedback.textContent = "";
        }, 4000);
      });
    </script>
  </body>
</html>
