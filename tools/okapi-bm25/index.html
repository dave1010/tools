<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Okapi BM25 Ranker</title>
    <link rel="stylesheet" href="/assets/tw.css" />
  </head>
  <body class="bg-slate-50 text-slate-900">
    <main class="mx-auto max-w-3xl p-4 md:p-6 space-y-4 font-sans">
      <header class="space-y-2">
        <h1 class="text-3xl font-semibold text-slate-900">Okapi BM25 Ranker</h1>
        <p class="text-sm text-slate-600">
          Paste documents, enter a query, and compute BM25 relevance scores.
        </p>
      </header>

      <section class="grid gap-4 md:grid-cols-[1.2fr_0.8fr]">
        <div class="space-y-3">
          <label class="text-sm font-medium text-slate-700" for="documents">Documents (one per line)</label>
          <textarea
            id="documents"
            class="min-h-[220px] w-full rounded-md border border-slate-200 bg-white p-3 text-sm shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100"
            placeholder="Example:\nThe quick brown fox jumps over the lazy dog.\nBM25 ranks documents using term frequency and inverse document frequency.\nSearch engines rely on ranking algorithms."
          ></textarea>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-secondary" type="button" data-sample="news">Load news set</button>
            <button class="btn btn-secondary" type="button" data-sample="tech">Load tech set</button>
            <button class="btn btn-secondary" type="button" data-sample="travel">Load travel set</button>
          </div>
        </div>
        <div class="space-y-4">
          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-700" for="query">Query</label>
            <input
              id="query"
              type="text"
              class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100"
              placeholder="enter search terms"
            />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-xs font-medium uppercase tracking-wide text-slate-500" for="k1">k1</label>
              <input
                id="k1"
                type="number"
                step="0.1"
                min="0"
                value="1.5"
                class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100"
              />
            </div>
            <div class="space-y-1">
              <label class="text-xs font-medium uppercase tracking-wide text-slate-500" for="b">b</label>
              <input
                id="b"
                type="number"
                step="0.05"
                min="0"
                max="1"
                value="0.75"
                class="w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100"
              />
            </div>
          </div>
          <button id="rank" class="btn btn-primary w-full">Rank documents</button>
          <div class="rounded-md border border-blue-100 bg-blue-50 p-3 text-xs text-blue-900">
            Scores use natural-log IDF and classic BM25 with average document length normalization.
          </div>
        </div>
      </section>

      <section class="space-y-2">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-slate-900">Results</h2>
          <button id="copy" class="btn btn-secondary">Copy scores</button>
        </div>
        <div class="overflow-hidden rounded-md border border-slate-200 bg-white">
          <table class="min-w-full divide-y divide-slate-200 text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="px-4 py-2 text-left font-medium">Rank</th>
                <th class="px-4 py-2 text-left font-medium">Score</th>
                <th class="px-4 py-2 text-left font-medium">Document</th>
              </tr>
            </thead>
            <tbody id="results" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
        <p id="empty" class="text-sm text-slate-500">No results yet. Add documents and run the ranker.</p>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">‚Üê Back to tools.dave.engineer</a>
          <a
            href="https://github.com/dave1010/tools/tree/main/tools/okapi-bm25"
            class="font-medium text-brand-700 hover:text-brand-600"
            >About</a
          >
        </div>
      </footer>
    </main>

    <script>
      const tokenize = (text) =>
        text
          .toLowerCase()
          .split(/[^\p{L}\p{N}]+/u)
          .filter(Boolean);

      const byId = (id) => document.getElementById(id);

      const documentsEl = byId("documents");
      const queryEl = byId("query");
      const k1El = byId("k1");
      const bEl = byId("b");
      const resultsEl = byId("results");
      const emptyEl = byId("empty");
      const sampleSets = {
        news: [
          "City transit report highlights transit delays and bus delays downtown.",
          "Transit riders want faster bus service, fewer delays, and more night routes.",
          "Council budget overview: new buses, transit hubs, and safety upgrades.",
          "Short bulletin: transit delay resolved after signal repair."
        ],
        tech: [
          "Search ranking models balance relevance and speed in neural search.",
          "Ranking systems use ranking signals, query signals, and relevance tuning.",
          "A long technical note on ranking: ranking pipelines tokenize queries, apply relevance scoring, and merge ranking results for search.",
          "Quick tip: search results feel better when ranking prioritizes relevance."
        ],
        travel: [
          "Hiking guide: mountain trail trail maps, trail safety, and trail snacks.",
          "Weekend trip notes mention trails, a short trail loop, and scenic trail photos.",
          "Travel itinerary: coastal trail walk, museum visit, and cafe stop.",
          "Trail report: muddy trail sections after rain, but the trail view is worth it."
        ]
      };

      const clearResults = () => {
        resultsEl.innerHTML = "";
        emptyEl.classList.remove("hidden");
      };

      const renderResults = (rows) => {
        resultsEl.innerHTML = "";
        if (!rows.length) {
          emptyEl.classList.remove("hidden");
          return;
        }
        emptyEl.classList.add("hidden");
        rows.forEach((row, index) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="px-4 py-2 font-medium text-slate-700">${index + 1}</td>
            <td class="px-4 py-2 font-mono text-slate-900">${row.score.toFixed(4)}</td>
            <td class="px-4 py-2 text-slate-700">${row.document}</td>
          `;
          resultsEl.appendChild(tr);
        });
      };

      const computeBM25 = (documents, queryTokens, k1, b) => {
        const tokenizedDocs = documents.map((doc) => tokenize(doc));
        const docLengths = tokenizedDocs.map((tokens) => tokens.length || 1);
        const avgDocLength =
          docLengths.reduce((sum, len) => sum + len, 0) / docLengths.length;
        const docFrequencies = new Map();

        tokenizedDocs.forEach((tokens) => {
          const seen = new Set(tokens);
          seen.forEach((token) => {
            docFrequencies.set(token, (docFrequencies.get(token) || 0) + 1);
          });
        });

        return documents.map((doc, index) => {
          const tokens = tokenizedDocs[index];
          const length = docLengths[index];
          const termCounts = new Map();
          tokens.forEach((token) => {
            termCounts.set(token, (termCounts.get(token) || 0) + 1);
          });

          let score = 0;
          queryTokens.forEach((term) => {
            const df = docFrequencies.get(term) || 0;
            if (!df) return;
            const idf = Math.log((documents.length - df + 0.5) / (df + 0.5) + 1);
            const tf = termCounts.get(term) || 0;
            const numerator = tf * (k1 + 1);
            const denominator = tf + k1 * (1 - b + (b * length) / avgDocLength);
            score += idf * (denominator === 0 ? 0 : numerator / denominator);
          });

          return { document: doc, score };
        });
      };

      const rankDocuments = () => {
        const documents = documentsEl.value
          .split(/\n+/)
          .map((line) => line.trim())
          .filter(Boolean);
        const queryTokens = tokenize(queryEl.value);
        const k1 = Number.parseFloat(k1El.value) || 0;
        const b = Math.min(1, Math.max(0, Number.parseFloat(bEl.value) || 0));

        if (!documents.length || !queryTokens.length) {
          clearResults();
          return;
        }

        const rows = computeBM25(documents, queryTokens, k1, b)
          .sort((a, b) => b.score - a.score)
          .filter((row) => row.score > 0);

        renderResults(rows);
      };

      byId("rank").addEventListener("click", rankDocuments);
      documentsEl.addEventListener("input", () => clearResults());
      queryEl.addEventListener("input", () => clearResults());

      document.querySelectorAll("[data-sample]").forEach((button) => {
        button.addEventListener("click", () => {
          const key = button.dataset.sample;
          if (!sampleSets[key]) return;
          documentsEl.value = sampleSets[key].join("\n");
          clearResults();
        });
      });

      byId("copy").addEventListener("click", async () => {
        const rows = Array.from(resultsEl.querySelectorAll("tr"));
        if (!rows.length) return;
        const lines = rows.map((row) => {
          const cells = row.querySelectorAll("td");
          return `${cells[0].textContent}\t${cells[1].textContent}\t${cells[2].textContent}`;
        });
        await navigator.clipboard.writeText(lines.join("\n"));
      });
    </script>
  </body>
</html>
