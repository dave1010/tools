<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MicroPython Web REPL</title>
    <link rel="stylesheet" href="/assets/tw.css" />
  </head>
  <body class="bg-gradient-to-b from-brand-50/60 to-white">
    <main class="mx-auto max-w-3xl space-y-6 p-4 font-sans md:p-6">
      <header class="space-y-2 text-center">
        <h1 class="text-3xl font-semibold text-gray-900">MicroPython Web REPL</h1>
        <p class="text-xs text-gray-500">
          Based on the original <a class="font-medium text-brand-700 hover:text-brand-600" href="https://tools.simonwillison.net/micropython" target="_blank" rel="noreferrer">MicroPython WASM demo by Simon Willison</a>.
        </p>
      </header>

      <section class="flex flex-col gap-4 rounded-2xl bg-white p-6 shadow">
        <div class="rounded-xl bg-gray-900 p-4 text-gray-100 shadow-inner">
          <pre id="console" class="max-h-[55vh] overflow-auto text-sm leading-relaxed" aria-live="polite"></pre>
        </div>

        <div class="space-y-3">
          <textarea
            id="codeInput"
            class="h-36 w-full rounded-xl border border-gray-300 bg-white px-4 py-3 font-mono text-sm text-gray-900 shadow-inner focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
            spellcheck="false"
            aria-label="MicroPython input">print('hello from MicroPython!')</textarea>

          <div class="flex flex-wrap items-center gap-3">
            <button id="runButton" class="btn btn-primary" disabled>Initializing…</button>
            <button id="clearButton" class="btn btn-secondary" type="button">Clear output</button>
            <span class="text-xs text-gray-500">Enter runs the snippet; Shift+Enter adds a new line.</span>
          </div>
        </div>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">← Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/micropython-repl" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script type="module">
      import * as mpjs from 'https://cdn.jsdelivr.net/npm/@micropython/micropython-webassembly-pyscript@1.26.0/micropython.mjs';

      const runButton = document.getElementById('runButton');
      const clearButton = document.getElementById('clearButton');
      const consoleEl = document.getElementById('console');
      const codeInput = document.getElementById('codeInput');

      const keepInputFocused = () => requestAnimationFrame(() => {
        codeInput.focus({ preventScroll: true });
        const end = codeInput.value.length;
        codeInput.setSelectionRange(end, end);
      });

      [runButton, clearButton].forEach((btn) => {
        btn.addEventListener('pointerdown', (event) => event.preventDefault());
      });

      const appendLine = (line = '') => {
        consoleEl.textContent += `${line}\n`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
      };

      const appendPrompt = (code) => {
        const lines = code.split(/\r?\n/);
        lines.forEach((line, index) => {
          const prefix = index === 0 ? '>>> ' : '... ';
          appendLine(prefix + line);
        });
      };

      let mp;
      let activeCapture = null;

      const forwardOutput = (kind, text) => {
        if (!text) return;
        if (activeCapture) activeCapture[kind] += text;
        text.split(/\r?\n/).forEach((line, index, arr) => {
          if (line === '' && index === arr.length - 1) return;
          appendLine(line);
        });
      };

      const runWithCapture = async (source) => {
        const src = source.endsWith('\n') ? source : `${source}\n`;
        activeCapture = { stdout: '', stderr: '' };
        let error;
        try {
          await mp.runPythonAsync(src);
        } catch (err) {
          error = err;
        }
        const result = activeCapture;
        activeCapture = null;
        if (error && typeof error === 'object') {
          error.stdout = result.stdout;
          error.stderr = result.stderr;
        }
        if (error) throw error;
        return result;
      };

      const expressionKeywords = [
        'for',
        'while',
        'if',
        'elif',
        'else',
        'try',
        'except',
        'finally',
        'with',
        'def',
        'class',
        'import',
        'from',
        'global',
        'nonlocal',
        'assert',
        'pass',
        'break',
        'continue',
        'return',
        'raise',
        'lambda',
        'match',
        'case',
      ];

      const getTrailingExpression = (source) => {
        const lines = source.split(/\r?\n/).filter((line) => line.trim() !== '');
        if (!lines.length) return null;
        const candidate = lines[lines.length - 1].trim();
        if (!candidate || candidate.endsWith(':')) return null;
        if (expressionKeywords.some((kw) => candidate === kw || candidate.startsWith(`${kw} `))) return null;
        if (/^print\s*\(/.test(candidate)) return null;
        if (/[^=!<>]=[^=]/.test(candidate)) return null;
        return candidate;
      };

      const setReady = () => {
        runButton.disabled = false;
        runButton.textContent = 'Run snippet';
        keepInputFocused();
      };

      const setRunning = () => {
        runButton.disabled = true;
      };

      try {
        mp = await mpjs.loadMicroPython({
          linebuffer: true,
          stdout: (text) => forwardOutput('stdout', text),
          stderr: (text) => forwardOutput('stderr', text),
        });
        setReady();
      } catch (error) {
        runButton.disabled = true;
        appendLine(String(error?.message || error));
        throw error;
      }

      const runSnippet = async () => {
        if (runButton.disabled) return;
        setRunning();
        const snippet = codeInput.value;
        appendPrompt(snippet);
        try {
          await runWithCapture(snippet);
          const expr = getTrailingExpression(snippet);
          if (expr) {
            await runWithCapture(`__repl_value__ = (${expr})\nprint(repr(__repl_value__))\ndel __repl_value__`);
          }
        } catch (err) {
          if (err?.stdout) appendLine(err.stdout.trimEnd());
          if (err?.stderr) appendLine(err.stderr.trimEnd());
          appendLine(String(err?.message || err));
        } finally {
          setReady();
        }
      };

      runButton.addEventListener('click', runSnippet);

      codeInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey && !event.isComposing) {
          event.preventDefault();
          runSnippet();
        }
      });

      clearButton.addEventListener('click', () => {
        consoleEl.textContent = '';
        keepInputFocused();
      });

      keepInputFocused();
    </script>
  </body>
</html>
