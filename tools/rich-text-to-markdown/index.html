<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rich Text to Markdown</title>
    <link rel="stylesheet" href="/assets/tw.css" />
    <style>
      #pasteArea:empty::before {
        content: attr(data-placeholder);
        color: rgb(107 114 128);
      }

      #pasteArea:focus::before {
        content: '';
      }
    </style>
  </head>
  <body class="bg-brand-50 text-gray-900">
    <main class="mx-auto max-w-3xl p-4 md:p-6 space-y-4 font-sans">
      <header class="space-y-2">
        <h1 class="text-3xl font-semibold text-brand-700">Rich Text to Markdown</h1>
        <p class="text-gray-600">
          Focus the box below and paste any formatted content. The converted Markdown will appear instantly.
        </p>
      </header>

      <section class="space-y-3">
        <label id="pasteAreaLabel" class="block text-sm font-medium text-gray-700">Paste formatted content</label>
        <div
          id="pasteArea"
          class="w-full min-h-[180px] resize-vertical rounded-lg border border-brand-200 bg-white p-3 shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100"
          contenteditable="true"
          role="textbox"
          aria-multiline="true"
          tabindex="0"
          aria-labelledby="pasteAreaLabel"
          data-placeholder="Tap or click here, then paste your rich text (⌘/Ctrl + V)."
        ></div>
        <p class="text-sm text-gray-500">
          Tip: If your clipboard doesn&apos;t include formatting, the plain text will be used instead.
        </p>
      </section>

      <section id="resultWrapper" class="space-y-3 hidden">
        <div class="flex items-center justify-between gap-3">
          <label for="markdownOutput" class="block text-sm font-medium text-gray-700">Markdown output</label>
          <button id="copyButton" type="button" class="btn btn-primary">Copy Markdown</button>
        </div>
        <textarea
          id="markdownOutput"
          class="w-full min-h-[220px] resize-vertical rounded-lg border border-brand-200 bg-white p-3 font-mono text-sm shadow-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-100"
          readonly
        ></textarea>
        <p id="statusMessage" class="text-sm text-gray-500"></p>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">← Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/rich-text-to-markdown" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/turndown@7.2.0/dist/turndown.js" onerror="alert('Failed to load: ' + this.src)"></script>
    <script src="https://cdn.jsdelivr.net/npm/turndown-plugin-gfm@1.0.2/dist/turndown-plugin-gfm.js" onerror="alert('Failed to load: ' + this.src)"></script>
    <script>
      const pasteArea = document.getElementById('pasteArea');
      const resultWrapper = document.getElementById('resultWrapper');
      const markdownOutput = document.getElementById('markdownOutput');
      const statusMessage = document.getElementById('statusMessage');
      const copyButton = document.getElementById('copyButton');

      const turndownService = typeof TurndownService === 'function'
        ? new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
          })
        : null;

      if (turndownService && window.turndownPluginGfm && turndownPluginGfm.gfm) {
        turndownService.use(turndownPluginGfm.gfm);
      }

      const updateStatus = (message, type = 'info') => {
        statusMessage.textContent = message;
        statusMessage.className = `text-sm ${type === 'success' ? 'text-brand-600' : 'text-gray-500'}`;
      };

      const convertClipboardData = (event) => {
        const clipboardData = event.clipboardData || window.clipboardData;

        if (!clipboardData) {
          updateStatus('Unable to access clipboard data in this browser.');
          return;
        }

        const htmlData = clipboardData.getData('text/html');
        const plainText = clipboardData.getData('text/plain');
        let markdownText = '';
        let sourceType = '';

        if (htmlData) {
          if (turndownService) {
            try {
              markdownText = turndownService.turndown(htmlData);
              sourceType = 'rich text';
            } catch (error) {
              console.error('Turndown conversion failed', error);
              markdownText = plainText;
              sourceType = 'plain text (fallback)';
            }
          } else {
            markdownText = plainText;
            sourceType = markdownText ? 'plain text (fallback)' : '';
            if (!markdownText) {
              updateStatus('The Markdown converter is unavailable. Try reloading the page.', 'info');
              return;
            }
          }
        } else if (plainText) {
          markdownText = plainText;
          sourceType = 'plain text';
        }

        markdownText = markdownText.trim();

        if (!markdownText) {
          updateStatus('Nothing to convert from the clipboard.');
          resultWrapper.classList.add('hidden');
          markdownOutput.value = '';
          return;
        }

        markdownOutput.value = markdownText;
        resultWrapper.classList.remove('hidden');
        const successMessage = sourceType
          ? `Converted from ${sourceType}.`
          : 'Converted clipboard contents.';
        updateStatus(successMessage, 'success');
      };

      pasteArea.addEventListener('paste', convertClipboardData);

      copyButton.addEventListener('click', async () => {
        const value = markdownOutput.value;
        try {
          await navigator.clipboard.writeText(value);
          updateStatus('Markdown copied to clipboard.', 'success');
        } catch (error) {
          console.warn('Clipboard copy failed', error);
          markdownOutput.removeAttribute('readonly');
          markdownOutput.focus();
          markdownOutput.select();
          markdownOutput.setAttribute('readonly', '');
          updateStatus('Press ⌘/Ctrl + C to copy.', 'info');
        }
      });

      window.addEventListener('load', () => {
        try {
          pasteArea.focus({ preventScroll: true });
        } catch (error) {
          pasteArea.focus();
        }
      });
    </script>
  </body>
</html>
