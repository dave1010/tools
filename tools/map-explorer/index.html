<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map Explorer</title>
  <link rel="stylesheet" href="/assets/tw.css">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
  <style>
    #map {
      position: absolute;
      inset: 0;
    }
  </style>
</head>
<body class="bg-slate-950 text-white">
  <main class="relative flex min-h-screen flex-col font-sans">
    <section class="relative flex-1">
      <div id="map" role="presentation" aria-hidden="true"></div>
      <div class="pointer-events-none absolute inset-0 flex items-start justify-start">
        <div class="pointer-events-auto p-4">
          <div class="space-y-2 rounded-xl bg-slate-900/80 p-3 shadow-lg backdrop-blur">
            <button id="locate-button" class="w-full rounded-lg bg-brand-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 focus:ring-offset-slate-900">
              Find my location
            </button>
            <p id="status" class="text-xs text-slate-200" aria-live="polite">Tap the button to center on your location.</p>
          </div>
        </div>
      </div>
    </section>

    <footer class="bg-slate-900/70 py-3 text-center text-xs text-slate-300">
      <div class="flex justify-center gap-4">
        <a href="/" class="font-medium text-brand-300 hover:text-brand-200">&larr; Back to tools.dave.engineer</a>
        <a href="https://github.com/dave1010/tools/tree/main/tools/map-explorer" class="font-medium text-brand-300 hover:text-brand-200">About</a>
      </div>
    </footer>
  </main>

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const locateButton = document.getElementById('locate-button');
      const defaultButtonText = locateButton.textContent.trim();
      let isLocating = false;
      let userMarker = null;

      function updateStatus(message, type = 'info') {
        statusEl.textContent = message;
        statusEl.className = type === 'error'
          ? 'text-xs text-red-300'
          : 'text-xs text-slate-200';
      }

      if (typeof maplibregl === 'undefined') {
        updateStatus('Map could not load. Please try again later.', 'error');
        locateButton.disabled = true;
        return;
      }

      const map = new maplibregl.Map({
        container: 'map',
        style: 'https://tiles.openfreemap.org/styles/liberty',
        center: [0, 20],
        zoom: 2,
        attributionControl: true,
        cooperativeGestures: true
      });

      map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');

      function resetButton() {
        isLocating = false;
        locateButton.disabled = false;
        locateButton.textContent = defaultButtonText;
      }

      function showPosition(position) {
        const { latitude, longitude, accuracy } = position.coords;
        const lngLat = [longitude, latitude];

        if (!userMarker) {
          userMarker = new maplibregl.Marker({ color: '#3b82f6' });
        }

        userMarker.setLngLat(lngLat).addTo(map);
        map.easeTo({ center: lngLat, zoom: Math.max(map.getZoom(), 14), duration: 1200 });
        updateStatus(accuracy ? `Accuracy ±${Math.round(accuracy)} m` : 'Location updated.');
      }

      function handleError(error) {
        let message = 'Unable to retrieve your location.';
        if (error.code === error.PERMISSION_DENIED) {
          message = 'Location access was denied.';
        } else if (error.code === error.POSITION_UNAVAILABLE) {
          message = 'Location information is unavailable.';
        } else if (error.code === error.TIMEOUT) {
          message = 'Timed out while trying to locate you.';
        }
        updateStatus(message, 'error');
      }

      locateButton.addEventListener('click', () => {
        if (!('geolocation' in navigator)) {
          updateStatus('Geolocation is not supported on this device.', 'error');
          locateButton.disabled = true;
          return;
        }

        if (isLocating) {
          return;
        }

        isLocating = true;
        locateButton.disabled = true;
        locateButton.textContent = 'Locating…';
        updateStatus('Locating…');

        navigator.geolocation.getCurrentPosition(
          (position) => {
            resetButton();
            showPosition(position);
          },
          (error) => {
            resetButton();
            handleError(error);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });
    })();
  </script>
</body>
</html>
