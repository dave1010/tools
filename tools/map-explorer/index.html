<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Map Explorer</title>
  <link rel="stylesheet" href="/assets/tw.css">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
  <style>
    #map {
      position: absolute;
      inset: 0;
    }
  </style>
</head>
<body class="bg-slate-950 text-white">
  <main class="relative min-h-screen font-sans">
    <div id="map" role="presentation" aria-hidden="true"></div>

    <div class="pointer-events-none absolute inset-0 flex flex-col justify-between">
      <div class="flex justify-start">
        <div class="pointer-events-auto p-4">
          <div class="space-y-2 rounded-xl bg-slate-900/80 p-3 shadow-lg backdrop-blur">
            <button
              id="locate-button"
              class="flex h-12 w-12 items-center justify-center rounded-full bg-brand-600 text-xl text-white transition hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 focus:ring-offset-slate-900"
              type="button"
              aria-label="Center map on my location"
              title="Center map on my location"
            >
              <span aria-hidden="true">⌖</span>
            </button>
            <p id="status" class="hidden text-xs text-slate-200" aria-live="polite"></p>
          </div>
        </div>
      </div>

      <div class="flex justify-start">
        <div class="pointer-events-auto p-4">
          <div class="space-y-2 text-xs">
            <button
              id="links-toggle"
              type="button"
              class="rounded-lg bg-slate-900/80 px-3 py-2 font-medium text-slate-100 shadow-lg backdrop-blur transition hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 focus:ring-offset-slate-900"
              aria-expanded="false"
              aria-controls="links-panel"
            >
              Links
            </button>
            <div
              id="links-panel"
              class="hidden rounded-lg bg-slate-900/80 p-3 text-slate-200 shadow-lg backdrop-blur"
              role="group"
              aria-label="Map explorer links"
            >
              <nav class="flex flex-col gap-2">
                <a href="/" class="font-medium text-brand-300 hover:text-brand-200">&larr; Back to tools.dave.engineer</a>
                <a href="https://github.com/dave1010/tools/tree/main/tools/map-explorer" class="font-medium text-brand-300 hover:text-brand-200">About</a>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const locateButton = document.getElementById('locate-button');
      const linksToggle = document.getElementById('links-toggle');
      const linksPanel = document.getElementById('links-panel');
      const defaultButtonContent = locateButton.innerHTML;
      let isLocating = false;
      let userMarker = null;

      function updateStatus(message, type = 'info') {
        if (!statusEl) return;

        if (!message) {
          statusEl.textContent = '';
          statusEl.classList.add('hidden');
          statusEl.classList.remove('text-red-300', 'text-slate-200');
          return;
        }

        statusEl.textContent = message;
        statusEl.classList.remove('hidden', 'text-red-300', 'text-slate-200');
        statusEl.classList.add(type === 'error' ? 'text-red-300' : 'text-slate-200');
      }

      if (typeof maplibregl === 'undefined') {
        updateStatus('Map could not load. Please try again later.', 'error');
        locateButton.disabled = true;
        return;
      }

      const map = new maplibregl.Map({
        container: 'map',
        style: 'https://tiles.openfreemap.org/styles/liberty',
        center: [0, 20],
        zoom: 2,
        attributionControl: true
      });

      map.addControl(new maplibregl.NavigationControl(), 'top-right');

      function resetButton() {
        isLocating = false;
        locateButton.disabled = false;
        locateButton.removeAttribute('aria-busy');
        locateButton.classList.remove('animate-pulse');
        locateButton.innerHTML = defaultButtonContent;
      }

      function showPosition(position) {
        const { latitude, longitude, accuracy } = position.coords;
        const lngLat = [longitude, latitude];

        if (!userMarker) {
          userMarker = new maplibregl.Marker({ color: '#3b82f6' });
        }

        userMarker.setLngLat(lngLat).addTo(map);
        map.easeTo({ center: lngLat, zoom: Math.max(map.getZoom(), 14), duration: 1200 });
        updateStatus(accuracy ? `Accuracy ±${Math.round(accuracy)} m` : 'Location updated.');
      }

      function handleError(error) {
        let message = 'Unable to retrieve your location.';
        if (error.code === error.PERMISSION_DENIED) {
          message = 'Location access was denied.';
        } else if (error.code === error.POSITION_UNAVAILABLE) {
          message = 'Location information is unavailable.';
        } else if (error.code === error.TIMEOUT) {
          message = 'Timed out while trying to locate you.';
        }
        updateStatus(message, 'error');
      }

      locateButton.addEventListener('click', () => {
        if (!('geolocation' in navigator)) {
          updateStatus('Geolocation is not supported on this device.', 'error');
          locateButton.disabled = true;
          return;
        }

        if (isLocating) {
          return;
        }

        isLocating = true;
        locateButton.disabled = true;
        locateButton.setAttribute('aria-busy', 'true');
        locateButton.classList.add('animate-pulse');
        updateStatus('Locating…');

        navigator.geolocation.getCurrentPosition(
          (position) => {
            resetButton();
            showPosition(position);
          },
          (error) => {
            resetButton();
            handleError(error);
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          }
        );
      });

      if (linksToggle && linksPanel) {
        linksToggle.addEventListener('click', () => {
          const isHidden = linksPanel.classList.toggle('hidden');
          linksToggle.setAttribute('aria-expanded', String(!isHidden));
        });
      }
    })();
  </script>
</body>
</html>
