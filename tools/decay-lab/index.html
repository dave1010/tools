<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decay Lab</title>
    <link rel="stylesheet" href="/assets/tw.css" />
  </head>
  <body class="min-h-screen bg-gradient-to-b from-brand-50/60 via-white to-white text-gray-900">
    <main class="mx-auto max-w-3xl space-y-4 p-4 font-sans md:p-6">
      <header class="space-y-2 text-center">
        <p class="text-sm font-medium uppercase tracking-wide text-brand-700">Scientific utility</p>
        <h1 class="text-3xl font-semibold">Decay Lab</h1>
        <p class="text-gray-600">
          Visualize exponential decay with adjustable half-life, starting mass, and observation window.
          Compare decay fractions, key milestones, and a live curve with gridlines.
        </p>
      </header>

      <section class="rounded-2xl border border-gray-200 bg-white p-4 shadow-soft md:p-6">
        <div class="grid gap-6 md:grid-cols-[minmax(0,1fr)_minmax(0,280px)] md:items-start">
          <div class="space-y-4">
            <div class="rounded-xl border border-gray-100 bg-brand-50/60 p-4">
              <h2 class="text-lg font-semibold text-gray-900">Inputs</h2>
              <div class="mt-3 grid gap-3 md:grid-cols-2">
                <label class="space-y-1 text-sm font-medium text-gray-700">
                  <span>Initial quantity (grams)</span>
                  <input
                    id="initialQuantity"
                    type="number"
                    min="0.01"
                    step="0.1"
                    value="100"
                    class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-gray-900 shadow-inner focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500"
                  />
                </label>
                <label class="space-y-1 text-sm font-medium text-gray-700">
                  <span>Half-life (hours)</span>
                  <input
                    id="halfLife"
                    type="number"
                    min="0.05"
                    step="0.05"
                    value="3"
                    class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-gray-900 shadow-inner focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500"
                  />
                </label>
                <label class="space-y-1 text-sm font-medium text-gray-700">
                  <span>Observation window (hours)</span>
                  <input
                    id="duration"
                    type="number"
                    min="0.5"
                    step="0.5"
                    value="24"
                    class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-gray-900 shadow-inner focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500"
                  />
                </label>
                <label class="space-y-1 text-sm font-medium text-gray-700">
                  <span>Sample every (hours)</span>
                  <input
                    id="resolution"
                    type="number"
                    min="0.1"
                    step="0.1"
                    value="0.5"
                    class="w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-gray-900 shadow-inner focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500"
                  />
                </label>
              </div>
              <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-gray-600">
                <label class="flex items-center gap-2">
                  <input id="showGrid" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-brand-600" />
                  <span>Show gridlines</span>
                </label>
                <label class="flex items-center gap-2">
                  <input id="showMarkers" type="checkbox" checked class="h-4 w-4 rounded border-gray-300 text-brand-600" />
                  <span>Show data markers</span>
                </label>
              </div>
            </div>

            <div class="relative overflow-hidden rounded-2xl border border-gray-200 bg-gray-900">
              <canvas id="decayChart" class="block h-[360px] w-full" aria-label="Decay curve"></canvas>
              <div class="pointer-events-none absolute inset-x-3 bottom-3 flex items-center justify-between rounded-full bg-gray-900/75 px-3 py-1 text-[11px] font-medium text-gray-100">
                <span>Quantity vs. time</span>
                <span>Decays by a factor of 2 every half-life</span>
              </div>
            </div>
          </div>

          <aside class="space-y-4 rounded-xl border border-gray-100 bg-gray-50 p-4">
            <div>
              <h2 class="text-lg font-semibold text-gray-900">Key milestones</h2>
              <dl class="mt-3 space-y-2 text-sm text-gray-700" id="milestones"></dl>
            </div>
            <div class="border-t border-gray-200 pt-3">
              <h2 class="text-lg font-semibold text-gray-900">Current status</h2>
              <ul id="statusList" class="mt-3 space-y-1 text-sm text-gray-700"></ul>
            </div>
          </aside>
        </div>

        <div class="mt-6 overflow-hidden rounded-xl border border-gray-200">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50 text-left font-semibold text-gray-700">
              <tr>
                <th class="px-4 py-2">Time (h)</th>
                <th class="px-4 py-2">Quantity</th>
                <th class="px-4 py-2">Remaining (%)</th>
              </tr>
            </thead>
            <tbody id="dataRows" class="divide-y divide-gray-100 bg-white"></tbody>
          </table>
        </div>
      </section>

      <footer class="py-6 text-center text-sm text-gray-500">
        <div class="flex justify-center gap-4">
          <a href="/" class="font-medium text-brand-700 hover:text-brand-600">← Back to tools.dave.engineer</a>
          <a href="https://github.com/dave1010/tools/tree/main/tools/decay-lab" class="font-medium text-brand-700 hover:text-brand-600">About</a>
        </div>
      </footer>
    </main>

    <script>
      const initialQuantityInput = document.getElementById("initialQuantity");
      const halfLifeInput = document.getElementById("halfLife");
      const durationInput = document.getElementById("duration");
      const resolutionInput = document.getElementById("resolution");
      const showGridInput = document.getElementById("showGrid");
      const showMarkersInput = document.getElementById("showMarkers");
      const canvas = document.getElementById("decayChart");
      const ctx = canvas.getContext("2d");
      const dataRows = document.getElementById("dataRows");
      const milestonesList = document.getElementById("milestones");
      const statusList = document.getElementById("statusList");

      function readNumber(input, fallback) {
        const value = parseFloat(input.value);
        if (Number.isFinite(value) && value > 0) return value;
        input.value = fallback;
        return fallback;
      }

      function decayValue(n0, halfLife, time) {
        const exponent = -time / halfLife;
        return n0 * 2 ** exponent;
      }

      function generateData() {
        const n0 = readNumber(initialQuantityInput, 100);
        const halfLife = readNumber(halfLifeInput, 3);
        const duration = readNumber(durationInput, 24);
        const step = readNumber(resolutionInput, 0.5);

        const times = [];
        for (let t = 0; t <= duration + 1e-9; t += step) {
          times.push(Math.round(t * 100) / 100);
        }

        const points = times.map((t) => ({
          time: t,
          value: decayValue(n0, halfLife, t),
        }));

        return { n0, halfLife, duration, step, points };
      }

      function formatNumber(value) {
        if (value >= 10) return value.toFixed(1);
        if (value >= 1) return value.toFixed(2);
        return value.toExponential(2);
      }

      function renderTable(points, n0) {
        dataRows.innerHTML = points
          .map(({ time, value }) => {
            const percent = ((value / n0) * 100).toFixed(2);
            return `
              <tr>
                <td class="px-4 py-2 text-gray-700">${time}</td>
                <td class="px-4 py-2 font-medium text-gray-900">${formatNumber(value)}</td>
                <td class="px-4 py-2 text-gray-700">${percent}%</td>
              </tr>
            `;
          })
          .join("");
      }

      function renderMilestones(n0, halfLife) {
        const milestones = [
          { label: "Half remaining", fraction: 0.5 },
          { label: "Quarter remaining", fraction: 0.25 },
          { label: "Tenth remaining", fraction: 0.1 },
          { label: "1% remaining", fraction: 0.01 },
        ];

        milestonesList.innerHTML = milestones
          .map(({ label, fraction }) => {
            const time = halfLife * Math.log2(1 / fraction);
            const remaining = n0 * fraction;
            return `
              <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2">
                <dt class="text-gray-700">${label}</dt>
                <dd class="text-right text-gray-900">
                  <div class="font-semibold">${time.toFixed(2)} h</div>
                  <div class="text-xs text-gray-500">≈ ${formatNumber(remaining)} units</div>
                </dd>
              </div>
            `;
          })
          .join("");
      }

      function renderStatus(n0, halfLife, duration) {
        const finalValue = decayValue(n0, halfLife, duration);
        const percentRemaining = ((finalValue / n0) * 100).toFixed(2);
        const decayConstant = Math.log(2) / halfLife;
        const meanLifetime = 1 / decayConstant;

        statusList.innerHTML = `
          <li class="flex items-center justify-between">
            <span>Final quantity at ${duration} h</span>
            <span class="font-semibold text-gray-900">${formatNumber(finalValue)} (${percentRemaining}% of start)</span>
          </li>
          <li class="flex items-center justify-between">
            <span>Decay constant (λ)</span>
            <span class="font-semibold text-gray-900">${decayConstant.toFixed(4)} h⁻¹</span>
          </li>
          <li class="flex items-center justify-between">
            <span>Mean lifetime (1/λ)</span>
            <span class="font-semibold text-gray-900">${meanLifetime.toFixed(2)} h</span>
          </li>
          <li class="flex items-center justify-between">
            <span>Half-lives elapsed</span>
            <span class="font-semibold text-gray-900">${(duration / halfLife).toFixed(2)}</span>
          </li>
        `;
      }

      function renderChart(points, n0, duration) {
        const { width } = canvas.getBoundingClientRect();
        canvas.width = width * devicePixelRatio;
        canvas.height = 360 * devicePixelRatio;
        ctx.save();
        ctx.scale(devicePixelRatio, devicePixelRatio);
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const padding = { top: 16, right: 20, bottom: 40, left: 52 };
        const innerWidth = width - padding.left - padding.right;
        const innerHeight = 360 - padding.top - padding.bottom;

        const maxY = n0;
        const minY = points[points.length - 1].value;

        const xScale = (t) => (t / duration) * innerWidth + padding.left;
        const yScale = (value) => {
          const ratio = (value - minY) / (maxY - minY || 1);
          return padding.top + (1 - ratio) * innerHeight;
        };

        ctx.translate(0.5, 0.5);
        ctx.strokeStyle = "#e5e7eb";
        ctx.lineWidth = 1;

        if (showGridInput.checked) {
          const gridCount = 6;
          for (let i = 0; i <= gridCount; i++) {
            const x = padding.left + (innerWidth / gridCount) * i;
            ctx.beginPath();
            ctx.moveTo(x, padding.top);
            ctx.lineTo(x, padding.top + innerHeight);
            ctx.stroke();
          }

          for (let i = 0; i <= gridCount; i++) {
            const y = padding.top + (innerHeight / gridCount) * i;
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(padding.left + innerWidth, y);
            ctx.stroke();
          }
        }

        ctx.strokeStyle = "#9ca3af";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top + innerHeight);
        ctx.lineTo(padding.left, padding.top);
        ctx.lineTo(padding.left + innerWidth, padding.top + innerHeight);
        ctx.stroke();

        ctx.strokeStyle = "#2563eb";
        ctx.lineWidth = 2;
        ctx.beginPath();
        points.forEach(({ time, value }, index) => {
          const x = xScale(time);
          const y = yScale(value);
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.stroke();

        if (showMarkersInput.checked) {
          ctx.fillStyle = "#1d4ed8";
          points.forEach(({ time, value }) => {
            const x = xScale(time);
            const y = yScale(value);
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
          });
        }

        ctx.fillStyle = "#111827";
        ctx.font = "12px 'Inter', system-ui, -apple-system, sans-serif";
        ctx.textAlign = "center";
        for (let i = 0; i <= 6; i++) {
          const t = (duration / 6) * i;
          const x = padding.left + (innerWidth / 6) * i;
          ctx.fillText(`${t.toFixed(1)} h`, x, padding.top + innerHeight + 24);
        }

        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        for (let i = 0; i <= 6; i++) {
          const yValue = minY + ((maxY - minY) / 6) * i;
          const y = padding.top + (innerHeight / 6) * (6 - i);
          ctx.fillText(formatNumber(yValue), padding.left - 8, y);
        }

        ctx.restore();
      }

      function update() {
        const { n0, halfLife, duration, points } = generateData();
        renderTable(points, n0);
        renderMilestones(n0, halfLife);
        renderStatus(n0, halfLife, duration);
        renderChart(points, n0, duration);
      }

      [
        initialQuantityInput,
        halfLifeInput,
        durationInput,
        resolutionInput,
        showGridInput,
        showMarkersInput,
      ].forEach((input) => input.addEventListener("input", update));

      window.addEventListener("resize", () => update());
      update();
    </script>
  </body>
</html>
